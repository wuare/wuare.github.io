---
title: zookeeper服务注册和发现
date: 2019-04-06 16:49:34
tags: Zookeeper
---
Zookeeper是一个为分布式应用提供一致性服务的组件，包括：配置信息维护、分布式同步、命名等等。
<!-- more -->
在分布式系统中，由于人工管理各个服务的复杂性，经常用Zookeeper作为服务注册发现中心。
# 注册发现原理
Zookeeper提供了一个类型Unix文件系统的树形存储结构，由一个个znode节点组成，其中节点可以存储数据。利用这个特点，可以很好地进行服务注册和发现。
一个服务包含的信息有：IP、端口、服务名称、ID以及一些额外的数据。
在进行服务注册的时候，只要在一个固定的路径下，添加一个以服务名称命名的节点，在该节点下添加各个服务的ID。例如：
```
                  /
                  |
              discovery
             /         \
  ServiceNameA        ServiceNameB
  /     |    \        /     |    \
 id_1  id_2  id_3    id_1  id_2  id_3
```
以上为服务信息储存的结构，由于单点服务的不可靠，我们一般都会对服务进行集群，所以以服务名称（ServieName）进行分组，服务名称下是一个个服务节点（id），该节点储存服务的信息（包括ip，端口等）。
在进行服务调用的时候，可以根据服务名进行查询，提供调用策略（如：随机调用一个服务，循环调用服务等），获取到相应的服务信息，然后进行调用。
在服务调用的时候有多种方法获取服务信息：
1. 在调用之前每次查询服务。
2. 在服务启动时查询所有服务信息缓存到本地，对服务名称节点增加监听，每次有新服务注册或者下线，通过监听更新本地缓存。

由于Zookeeper的Watcher机制只能触发一次，所以在触发之后需要重新监听，推荐使用Zookeeper的客户端Curator，Curator对监听进行了封装，使用Curator的API不需要重复监听，另外，Curator客户端提供了分布式锁、Leader选举等实现。
# 实现
[Curator](http://curator.apache.org/)是一个Zookeeper的Java客户端，它提供了一个服务注册发现的实现curator-x-discovery，源码地址：[Github](https://github.com/apache/curator)。